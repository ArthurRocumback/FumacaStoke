<!DOCTYPE html>
<html lang="pt-br">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Formulário de Preenchimento de Dados</title>
        
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> 
        
        <style>
            /* Switch de pedido pronto */
            .switch-toggle {
                position: relative;
                width: 60px;
                height: 30px;
            }

            .switch-toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider-toggle {
                position: absolute;
                cursor: pointer;
                inset: 0;
                background-color: #b8a8a8;
                border-radius: 30px;
                transition: background-color 0.4s ease;
            }

            .slider-toggle::before {
                content: "Não";
                position: absolute;
                height: 26px;
                width: 26px;
                left: 2px;
                bottom: 2px;
                background-color: #102c6b;
                color: #fff;
                font-size: 12px;
                font-weight: 500;
                font-family: 'Segoe UI', sans-serif;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: transform 0.4s ease, content 0.4s ease;
            }

            .switch-toggle input:checked + .slider-toggle {
                background-color: #60e672;
            }

            .switch-toggle input:checked + .slider-toggle::before {
                transform: translateX(30px);
                content: "Sim";
                background-color: #0d8327; /* Cor do Sim para contraste */
            }

            /* Estilos gerais */
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            .form-control, .form-select {
                border-color: #cfcfcf;
            }
            body {
                background-color: #f1f1f1 !important;
            }
        </style>
    </head>

    <body>
      <div class="container-fluid mt-3" style="width: 90%;">

        <nav class="navbar navbar-expand-lg navbar-light bg-light rounded d-flex justify-content-between mb-4 shadow-sm">
            <a class="navbar-brand" href="/index">Sistema de Pedidos</a>
            
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-user"></i> Menu
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                    
                    <h6 class="dropdown-header">Usuário: {{ session.get('usuario', 'Convidado')}}</h6>
                    <div class="dropdown-divider"></div>
                    
                    <a class="dropdown-item" href="/index">
                        <i class="fas fa-list-alt mr-2"></i> Lista de Pedidos
                    </a>
                    
                    {% if admin %}
                    <a class="dropdown-item" href="/historico">
                        <i class="fas fa-history mr-2"></i> Lista Total
                    </a>
                    {% endif %}

                    <div class="dropdown-divider"></div>
                    
                    <a class="dropdown-item text-danger" href="/logout">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </a>
                </div>
            </div>
        </nav>
        <form id="formPedido" action="javascript:void(0)" method="POST">
            <table class="table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>RG/CPF</th>
                        <th>Produto</th>
                        <th>Rosh</th>
                        <th>Essência</th>
                        <th>Observação</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="text" class="form-control" name="Nome_1" placeholder="abc">
                        </td>
                        <td>
                            <input type="text" class="form-control" name="RG_1" id="RG_1" maxlength="14" required placeholder="XX.XXX.XXX-X">
                        </td>   
                        <td>
                            <select id="produtos" name="produto_1" class="form-control" required></select>
                        </td>
                        <td>
                            <select id="roshs" name="Rosh_1" class="form-control" required></select>
                        </td>
                        <td>
                            <input type="text" class="form-control" name="Essencia" required>
                        </td>
                        <td>
                            <input type="text" class="form-control" name="Observação" required>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="form-group text-center">
                <button type="button" id="btnEnviar" class="btn btn-primary">Enviar</button>
            </div>
        </form>
        <h2 class="text-center">Pedidos</h2>
        <input type="text" id="filtroPedidos" class="form-control-sm w-25" placeholder="Buscar pedido, nome, produto...">
            <div class="mt-3 overflow-auto" style="max-height: 550px;">
            <table class="table table-striped table-bordered table-hover table-sm w-100" id="tabelaPedidos" style="border-collapse: separate; border-spacing: 0;">
                <thead style="position: sticky; top: 0; z-index: 2; background-color: #fff;">
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>RG/CPF</th>
                        <th>Produto</th>
                        <th>Rosh</th>
                        <th>Essência</th>
                        <th>Observação</th>
                        <th>Data/Hora</th>
                        <th>Ações</th>
                        <th>Pedido Pronto</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="paginacao" class="mt-2 d-flex justify-content-center align-items-center gap-2"></div>
    </div>

    <div class="modal fade" id="senhaModal" tabindex="-1" aria-labelledby="senhaModalLabel" aria-hidden="true">
        <div class="modal-dialog mt-5">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="senhaModalLabel">Confirmar Exclusão</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <label for="senhaInput" class="form-label">Digite a senha:</label>
                    <input type="password" class="form-control" id="senhaInput" placeholder="Senha" autofocus>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarSenha()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formEditar">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Editar Pedido</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                            <span aria-hidden="true">&times;</span>
                        </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editPedidoId">
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" class="form-control" id="editNome">
                    </div>
                    <div class="form-group">
                        <label>RG</label>
                        <input type="text" class="form-control" id="editRG">
                    </div>
                    <div class="form-group">
                        <label>Produto</label>
                        <select class="form-control" id="editProduto">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>Rosh</label>
                        <select class="form-control" id="editRosh">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>Essência</label>
                        <input type="text" class="form-control" id="editEssencia">
                    </div>
                    <div class="form-group">
                        <label>Observação</label>
                        <input type="text" class="form-control" id="editObservacao">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // =========================================================
        // FUNÇÃO DE MENSAGEM VAZIA (NOVA)
        // =========================================================
        function renderEmptyTableMessage(tbody, message) {
            // Conta quantas colunas existem no cabeçalho (thead) para que o colspan funcione
            const colunas = document.querySelectorAll('#tabelaPedidos thead th').length;
            
            // Retorna se não houver colunas (erro na tabela)
            if (colunas === 0) return; 

            const tr = document.createElement('tr');
            const td = document.createElement('td');
            
            // Configuração formal da mensagem
            td.setAttribute('colspan', colunas);
            td.classList.add('text-center', 'py-4', 'text-muted', 'lead', 'font-italic');
            td.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${message}`;

            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        let pedidoEditadoId = null;

        async function carregarDropdowns() {
            const produtoRes = await fetch('/api/produtos');
            const produtos = await produtoRes.json();
            const roshRes = await fetch('/api/roshs');
            const roshs = await roshRes.json();

            const produtoSelect = document.getElementById('produtos');
            const roshSelect = document.getElementById('roshs');

            produtoSelect.innerHTML = '<option value="" hidden></option>';
            roshSelect.innerHTML = '<option value="" hidden></option>';

            produtos.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod;
                option.textContent = prod;
                produtoSelect.appendChild(option);
            });

            roshs.forEach(rosh => {
                const option = document.createElement('option');
                option.value = rosh;
                option.textContent = rosh;
                roshSelect.appendChild(option);
            });
        }

        async function carregarPedidos() {
            try {
                const res = await fetch('/api/pedidos');
                const pedidos = await res.json();

                pedidos.sort((a, b) => b.pedidoid - a.pedidoid);

                pedidosArmazenados = pedidos;
                paginaAtual = 1;
                exibirPagina(paginaAtual);
                // Resumo(); // Comentei ou remova se não for mais usada
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                // Exibir mensagem de erro de API se falhar
                const tbody = document.querySelector('#tabelaPedidos tbody');
                tbody.innerHTML = '';
                renderEmptyTableMessage(tbody, 'Erro ao comunicar com a API. Por favor, tente novamente.');
            }
        }

        window.onload = async () => {
            await carregarDropdowns();
            await carregarPedidos();
        }

        document.getElementById('btnEnviar').addEventListener('click', async function () {
            // Preencher os dados
            const nome = document.querySelector('[name="Nome_1"]').value;
            const rg = document.querySelector('[name="RG_1"]').value;
            const produto = document.querySelector('[name="produto_1"]').value;
            const rosh = document.querySelector('[name="Rosh_1"]').value;
            const essencia = document.querySelector('[name="Essencia"]').value;
            const observacao = document.querySelector('[name="Observação"]').value;

            // Verifica se todos os campos estão preenchidos
            if (nome && rg && produto && rosh && essencia && observacao) {
                const pedidoData = { nome, rg, produto, rosh, essencia, observacao };
                
                await fetch('/api/pedido', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pedidoData)
                });

                // Limpar formulário
                document.getElementById('formPedido').reset();
                carregarPedidos();

            } else {
                alert('Por favor, preencha todos os campos.');
            }
        });
        // Envia os dados do formulario preenchido para o campo de pedidos
        function adicionarLinhaTabela(pedido) {
            const tbody = document.querySelector('#tabelaPedidos tbody');
            const tr = document.createElement('tr');
            const switchChecked = pedido.ativo ? 'checked' : '';

            tr.innerHTML = `
            <td>${pedido.pedidoid}</td>
            <td>${pedido.name}</td>
            <td>${pedido.rg}</td>
            <td>${pedido.nome_produto}</td>
            <td>${pedido.nome_rosh}</td>
            <td>${pedido.essencia}</td>
            <td>${pedido.observacao}</td>
            <td>${pedido.criacao}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editarPedido(${pedido.pedidoid}, this)">Editar</button>
                <button class="btn btn-danger btn-sm ml" onclick="excluirPedido(${pedido.pedidoid})">Excluir</button>
                <button class="btn btn-info btn-sm ml" onclick='preencherFormulario(${JSON.stringify(pedido)})'>Reutilizar</button>
                </td>
                <td>
                <label class="switch-toggle d-inline-block">
                <input type="checkbox" ${switchChecked} onchange="onToggleChange(this, ${pedido.pedidoid})">
                <span class="slider-toggle"></span>
                </label>
            </td>
            `;
            tbody.appendChild(tr);
        }
        
            function onToggleChange(checkbox, pedidoId) {
                const ativo = checkbox.checked ? 1 : 0;

                fetch(`/api/pedido/${pedidoId}/ativo`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ativo })
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Falha ao atualizar');
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Status atualizado:', data);
                })
                .catch(error => {
                    alert('Erro ao atualizar o status.');
                    console.error(error);
                });
            }

        async function editarPedido(id, btn) {
            const tr = btn.closest('tr');

            const nome = tr.cells[1].textContent;
            const rg = tr.cells[2].textContent;
            const produtoAtual = tr.cells[3].textContent;
            const roshAtual = tr.cells[4].textContent;
            const essencia = tr.cells[5].textContent;
            const observacao = tr.cells[6].textContent;

            document.getElementById('editPedidoId').value = id
            document.getElementById('editNome').value = tr.cells[1].textContent;
            document.getElementById('editRG').value = tr.cells[2].textContent;
            document.getElementById('editEssencia').value = tr.cells[5].textContent;
            document.getElementById('editObservacao').value = tr.cells[6].textContent;

            const produtoRes = await fetch('/api/produtos');
            const produtos = await produtoRes.json();
            const produtoSelect = document.getElementById('editProduto');
            produtoSelect.innerHTML = ''; // limpa antes de preencher

            produtos.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod;
                option.textContent = prod;
                if (prod === produtoAtual) option.selected = true;
                produtoSelect.appendChild(option);
            });

            const roshRes = await fetch('/api/roshs');
            const roshs = await roshRes.json();
            const roshSelect = document.getElementById('editRosh');
            roshSelect.innerHTML = ''; // limpa antes de preencher

            roshs.forEach(rosh => {
                const option = document.createElement('option');
                option.value = rosh;
                option.textContent = rosh;
                if (rosh === roshAtual) option.selected = true;
                roshSelect.appendChild(option);
            });
            $('#editModal').modal('show');
        }
        function preencherFormulario(pedido) {
            document.querySelector('[name="Nome_1"]').value = pedido.name;
            document.querySelector('[name="RG_1"]').value = pedido.rg;
            document.querySelector('[name="Essencia"]').value = pedido.essencia;
            document.querySelector('[name="Observação"]').value = pedido.observacao;

            const produtoSelect = document.getElementById('produtos');
            const roshSelect = document.getElementById('roshs');

            for (let option of produtoSelect.options) {
                if (option.value === 'Reposição') {
                    option.selected = true;
                    break;
                }
            }

            // Mantém seleção do rosh conforme o pedido
            for (let option of roshSelect.options) {
                if (option.value == pedido.nome_rosh) {
                    option.selected = true;
                    break;
                }
            }

            document.querySelector('[name="Nome_1"]').focus();
        }

        document.getElementById('formEditar').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('editPedidoId').value;
            const nome = document.getElementById('editNome').value.trim();
            const rg = document.getElementById('editRG').value.trim();
            const produto = document.getElementById('editProduto').value.trim();
            const rosh = document.getElementById('editRosh').value.trim();
            const essencia = document.getElementById('editEssencia').value.trim();
            const observacao = document.getElementById('editObservacao').value.trim();

            // Validação: verifica se os campos obrigatórios estão preenchidos
            if (!nome || !rg || !produto || !rosh || !essencia || !observacao) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const dadosAtualizados = {
                nome,
                rg,
                produto,
                rosh,
                essencia,
                observacao
            };

            try {
                const resposta = await fetch(`/api/pedido/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosAtualizados)
                });

                if (resposta.ok) {
                    $('#editModal').modal('hide');
                    await carregarPedidos();
                } else {
                    alert('Erro ao atualizar o pedido.');
                }
            } catch (erro) {
                console.error('Erro na atualização:', erro);
                alert('Erro ao tentar atualizar o pedido.');
            }
        });

          let pedidoIdParaExcluir = null;
            const senhaModal = new bootstrap.Modal(document.getElementById('senhaModal'));

            async function excluirPedido(id) {
            pedidoIdParaExcluir = id;
            document.getElementById('senhaInput').value = '';
            senhaModal.show();

            setTimeout(() => {
                document.getElementById('senhaInput').focus();
             }, 500);
            }
            document.addEventListener("DOMContentLoaded", function () {
                const senhaInput = document.getElementById('senhaInput');

                senhaInput.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                    event.preventDefault();
                    confirmarSenha(); 
                    }
                });
            });

            async function confirmarSenha() {
            const senha = document.getElementById('senhaInput').value;

            if (senha === '123') {
                try {
                const resposta = await fetch(`/api/pedido/${pedidoIdParaExcluir}`, { method: 'DELETE' });

                if (resposta.ok) {
                    carregarPedidos(); // Atualiza a tabela
                } else {
                    alert('Erro ao excluir o pedido no servidor.');
                    console.error('Erro DELETE:', resposta.statusText);
                }
                } catch (erro) {
                alert('Erro na conexão com o servidor.');
                console.error(erro);
                }
            } else {
                alert('Senha incorreta. Exclusão cancelada.');
            }
            senhaModal.hide();
            }
        // Máscara para o campo de RG
        function aplicarMascaraRG(input) {
            input.addEventListener('input', function (e) {
                let valor = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (valor.length > 11) {
                valor = valor.slice(0, 11);
                }
                if (valor.length === 9) {
                valor = valor.replace(/^(\d{2})(\d{3})(\d{3})(\d{1})$/, '$1.$2.$3-$4');
                } else if (valor.length >= 10) {
                valor = valor.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
                }
                e.target.value = valor;
            });
}
        aplicarMascaraRG(document.getElementById('RG_1'));
        aplicarMascaraRG(document.getElementById('editRG'));

        document.getElementById('formPedido').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('btnEnviar').click();
            }
        });

        let pedidosArmazenados = [];
                let paginaAtual = 1;
                const itensPorPagina = 10;

            function exibirPagina(pagina) {
                const tbody = document.querySelector('#tabelaPedidos tbody');
                tbody.innerHTML = '';
                document.getElementById('paginacao').style.display = 'flex'; // Garante que a paginação está visível (se houver dados)

                // NOVO: Verifica se há dados no total
                if (pedidosArmazenados.length === 0) {
                    renderEmptyTableMessage(tbody, 'Não há pedidos registrados atualmente.');
                    document.getElementById('paginacao').innerHTML = ''; 
                    return;
                }

                const inicio = (pagina - 1) * itensPorPagina;
                const fim = inicio + itensPorPagina;
                const pedidosPagina = pedidosArmazenados.slice(inicio, fim);

                pedidosPagina.forEach(pedido => adicionarLinhaTabela(pedido));

                paginaAtual = pagina;
                atualizarPaginacao();
                }

            function atualizarPaginacao() {
                const totalPaginas = Math.ceil(pedidosArmazenados.length / itensPorPagina);
                const paginacaoDiv = document.getElementById('paginacao');
                paginacaoDiv.innerHTML = '';

                if (totalPaginas <= 1) return;

                const criarBotaoSeta = (simbolo, novaPagina, habilitar) => {
                    const btn = document.createElement('button');
                    btn.textContent = simbolo;
                    btn.className = 'btn btn-outline-primary btn-sm';
                    btn.disabled = !habilitar;
                    if (habilitar) {
                    btn.onclick = () => exibirPagina(novaPagina);
                    }
                    return btn;
                };

                const anteriorHabilitado = paginaAtual > 1;
                paginacaoDiv.appendChild(criarBotaoSeta('‹', paginaAtual - 1, anteriorHabilitado));

                const texto = document.createElement('span');
                texto.textContent = `${paginaAtual} / ${totalPaginas}`;
                texto.className = 'mx-2 fw-bold';
                paginacaoDiv.appendChild(texto);

                const proximoHabilitado = paginaAtual < totalPaginas;
                paginacaoDiv.appendChild(criarBotaoSeta('›', paginaAtual + 1, proximoHabilitado));
                }

            document.getElementById('filtroPedidos').addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();
            const tbody = document.querySelector('#tabelaPedidos tbody');
            tbody.innerHTML = '';

            const resultadosFiltrados = pedidosArmazenados.filter(pedido => {
                const texto = (
                pedido.pedidoid +
                pedido.name +
                pedido.rg +
                pedido.nome_produto +
                pedido.nome_rosh +
                pedido.essencia +
                pedido.observacao +
                pedido.criacao
                ).toLowerCase();

                return texto.includes(termo);
            });

            // NOVO: Lógica para exibir a mensagem se o filtro não encontrar resultados
            if (resultadosFiltrados.length === 0) {
                renderEmptyTableMessage(tbody, 'Nenhum pedido encontrado com base no filtro atual.');
                document.getElementById('paginacao').style.display = 'none';
            } else {
                document.getElementById('paginacao').style.display = 'none'; // Continua escondida durante a filtragem

                resultadosFiltrados.forEach(pedido => {
                    adicionarLinhaTabela(pedido);
                });
            }
            });
    </script>
</body>
</html>