<!DOCTYPE html>
<html lang="pt-br">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Historico de Pedidos</title>
        
        <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> 
        
        <style>
            input[type="number"]::-webkit-outer-spin-button,
            input[type="number"]::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            .form-control, .form-select {
                border-color: #cfcfcf;
            }
            body {
                background-color: #f1f1f1 !important;
            }
            .table-total {
                font-weight: bold;
                background-color: #f8f9fa; 
            }
        </style>
    </head>

    <body>
        <div class="container-fluid mt-3" style="width: 90%;">

            <nav class="navbar navbar-expand-lg navbar-light bg-light rounded d-flex justify-content-between mb-4 shadow-sm">
                <a class="navbar-brand" href="/index">Fumaça Stoke</a>
                
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-user"></i> Menu
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                        
                        <h6 class="dropdown-header">Usuário: {{ session.get('usuario', '')}}</h6>
                        <div class="dropdown-divider"></div>
                        
                        <a class="dropdown-item" href="/index">
                            <i class="fas fa-list-alt mr-2"></i> Lista de Pedidos
                        </a>
                        
                        {% if admin %}
                        <a class="dropdown-item" href="/historico">
                            <i class="fas fa-history mr-2"></i> Lista Total
                        </a>
                        {% endif %}

                        <div class="dropdown-divider"></div>
                        
                        <a class="dropdown-item text-danger" href="/logout">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                        </a>
                    </div>
                </div>
            </nav>
            
            <div class="mt-2">
                <h2 class="text-center">Historico de Pedidos</h2>
                <div class="mb-2">
                    <input type="text" id="filtroPedidos" class="form-control-sm w-25" placeholder="Filtrar...">
                </div>
                
                <div class="overflow-auto" style="max-height: 550px;">
                    <table class="table table-striped table-bordered table-hover table-sm w-100" id="tabelaPedidos" style="border-collapse: separate; border-spacing: 0;">
                        <thead style="position: sticky; top: 0; z-index: 2; background-color: #fff;">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>RG/CPF</th>
                                <th>Produto</th>
                                <th>Rosh</th>
                                <th>Essência</th>
                                <th>Observação</th>
                                <th>Data/Hora</th>
                                <th>Valor Recebido</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                
                <div id="paginacao" class="mt-2 d-flex justify-content-center align-items-center gap-2"></div>
                <div id="resumoPedidos" class="mt-3 text-right"></div>
            </div>
            
            <table class="table table-bordered table-sm" id="tabelaResumo">
                <thead>
                    <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Total (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        
        <script>

            function renderEmptyTableMessage(tbody, message) {

                const colunas = document.querySelectorAll('#tabelaPedidos thead th').length;
                
                if (colunas === 0) return; 

                const tr = document.createElement('tr');
                const td = document.createElement('td');
                

                td.setAttribute('colspan', colunas);
                td.classList.add('text-center', 'py-4', 'text-muted', 'lead', 'font-italic', 'msg-vazio'); // Adiciona classe 'msg-vazio'
                td.innerHTML = `<i class="fas fa-info-circle mr-2"></i> ${message}`;

                tr.appendChild(td);
                tbody.appendChild(tr);
            }

            const valorPorProduto = {
                'Aluguel Médio': 40,
                'Aluguel Pequeno': 35,
                'Reposição': 20,
                'Funcionário': 10,
                'Da casa':0
            };
            
            let pedidosArmazenados = []; 

            async function carregarPedidos(){
                const res = await fetch('/api/pedidos/todos');
                const pedidos = await res.json();
                const tbody = document.querySelector('#tabelaPedidos tbody');
                tbody.innerHTML = '';
                
                pedidosArmazenados = pedidos;


                if (pedidos.length === 0) {
                    renderEmptyTableMessage(tbody, 'Não há histórico de pedidos registrado.');
                    Resumo(); 
                    return; 
                }

                pedidos.forEach(pedido => {
                    adicionarLinhaTabela(pedido);
                });
                
                Resumo(); 
            }

            window.onload = async () => {
                await carregarPedidos();
            }

            function adicionarLinhaTabela(pedido) {
                const tbody = document.querySelector('#tabelaPedidos tbody');
                const tr = document.createElement('tr');
                const valor = valorPorProduto[pedido.nome_produto] || 0;

                tr.innerHTML = `
                    <td>${pedido.pedidoid}</td>
                    <td>${pedido.name}</td>
                    <td>${pedido.rg}</td>
                    <td>${pedido.nome_produto}</td>
                    <td>${pedido.nome_rosh}</td>
                    <td>${pedido.essencia}</td>
                    <td>${pedido.observacao}</td>
                    <td>${pedido.criacao}</td>
                    <td>${valor}</td>
                    `;
                // Insere no final (Append) ou no início (Prepend). Mantendo o Prepend original, mas geralmente histórico é por ordem de data.
                tbody.prepend(tr); 
            }

            function Resumo() {
                const linhas = Array.from(document.querySelectorAll('#tabelaPedidos tbody tr'));
                
                const resumo = {};
                let totalGeral = 0;
                let quantidadeGeral = 0;

                linhas.forEach(linha => {

                    if (linha.style.display === 'none' || linha.classList.contains('msg-vazio')) {
                        return;
                    }
                    
                    const produto = linha.children[3].textContent;
                    const valor = parseFloat(linha.children[8].textContent) || 0; 

                    if (!resumo[produto]) {
                        resumo[produto] = { quantidade: 0, total: 0 };
                    }

                    resumo[produto].quantidade += 1;
                    resumo[produto].total += valor;

                    quantidadeGeral += 1;
                    totalGeral += valor;
                });

                const ordemProdutos = [
                    'Aluguel Pequeno',
                    'Aluguel Médio',
                    'Reposição',
                    'Funcionário',
                    'Da casa'
                    ];
                const tbodyResumo = document.querySelector('#tabelaResumo tbody');
                tbodyResumo.innerHTML = '';

                if (quantidadeGeral === 0) {
                     const trVazio = document.createElement('tr');
                     trVazio.innerHTML = `<td colspan="3" class="text-center text-muted">Resumo indisponível ou filtro ativo.</td>`;
                     tbodyResumo.appendChild(trVazio);
                     return;
                }

                ordemProdutos.forEach(produto => {
                    const dados = resumo[produto];
                    if (dados) {
                        const { quantidade, total } = dados;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${produto}</td>
                        <td>${quantidade}</td>
                        <td>R$ ${total.toFixed(2)}</td>
                        `;
                        tbodyResumo.appendChild(tr);
                    }
                });

                // Adiciona linha de total geral
                const trTotal = document.createElement('tr');
                trTotal.classList.add('table-total'); 

                trTotal.innerHTML = `
                <td>Total Geral</td>
                <td>${quantidadeGeral}</td>
                <td>R$ ${totalGeral.toFixed(2)}</td>
                `;
                tbodyResumo.appendChild(trTotal);
            }

            document.getElementById('filtroPedidos').addEventListener('input', function () {
                const filtro = this.value.toLowerCase();
                const tbody = document.querySelector('#tabelaPedidos tbody');
                const linhas = document.querySelectorAll('#tabelaPedidos tbody tr');
                let linhasVisiveis = 0;

                // Remove a mensagem de "vazio" anterior se houver
                document.querySelectorAll('#tabelaPedidos tbody .msg-vazio').forEach(el => el.remove()); 

                linhas.forEach(linha => {
                    // Ignora a linha da mensagem vazia se ela existir (previne erros)
                    if (linha.classList.contains('msg-vazio')) return; 

                    const textoLinha = linha.textContent.toLowerCase();
                    const corresponde = textoLinha.includes(filtro);
                    linha.style.display = corresponde ? '' : 'none';
                    if (corresponde) {
                        linhasVisiveis++;
                    }
                });

                if (linhasVisiveis === 0) {
                    renderEmptyTableMessage(tbody, 'Nenhum registro de pedido encontrado com base neste filtro.');
                }
                
                Resumo();
            });

            document.querySelectorAll('#tabelaPedidos th').forEach((th, index) => {
                th.style.cursor = 'pointer';
                let ascendente = true;

                th.addEventListener('click', () => {
                    const tbody = document.querySelector('#tabelaPedidos tbody');
                    const linhas = Array.from(tbody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('msg-vazio')); 

                    document.querySelectorAll('#tabelaPedidos th').forEach(th => {
                        th.textContent = th.textContent.replace(/[\u2191\u2193]/g, '').trim();
                    });

                    const nomeColuna = th.textContent.replace(/[\u2191\u2193]/g, '').trim();

                    linhas.sort((a, b) => {
                        const valA = a.children[index].textContent.trim().toLowerCase();
                        const valB = b.children[index].textContent.trim().toLowerCase();

                        const aNum = parseFloat(valA.replace(',', '.'));
                        const bNum = parseFloat(valB.replace(',', '.'));
                        const isNumero = !isNaN(aNum) && !isNaN(bNum);

                        if (isNumero) {
                            return ascendente ? aNum - bNum : bNum - aNum;
                        } else {
                            return ascendente ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        }
                    });

                    const mensagemVazia = tbody.querySelector('.msg-vazio');
                    tbody.innerHTML = '';
                    linhas.forEach(tr => tbody.appendChild(tr));
                    if (mensagemVazia) {
                        tbody.appendChild(mensagemVazia);
                    }

                    const seta = ascendente ? ' \u2191' : ' \u2193'; // ↑ ou ↓
                    th.textContent = nomeColuna + seta;

                    ascendente = !ascendente;
                });
            });
        </script>
    </body>
</html>